name: push.yml

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

#env:
  #BUILD_TYPE: Release

jobs:
  build:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v5
#      - name: Configure CMake
#        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
#      - name: Build
#        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
#      - name: Upload artifact
#        uses: actions/upload-artifact@v5
#        with:
#          name: drawcula
#          path: ${{ github.workspace }}/build/drawcula

      #- name: Test
     #   working-directory: ${{github.workspace}}/build
        # Execute tests defined by the CMake configuration.
        # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      #  run: ctest -C ${{env.BUILD_TYPE}}

#  docker:
#    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Clear cache
        uses: actions/github-script@v6
        with:
          script: |
            console.log("About to clear")
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            })
            for (const cache of caches.data.actions_caches) {
              console.log(cache)
              github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id,
              })
            }
            console.log("Clear completed")
      - name: Create directory
        run: mkdir -p ${{ github.workspace }}/engines
      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: drawcula
          path: ${{github.workspace}}/engines
      - name: Show path
        run: ls -la ${{ github.workspace }}/engines
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build Docker Image
        uses: docker/build-push-action@v6
        with:
          no-cache: true # TODO fix this
          pull: true # TODO fix this
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/drawcula:latest
          build-args: |
            LICHESS_BOT_TOKEN=${{ secrets.LICHESS_BOT_TOKEN }}
            GITHUB_DIR = "blablabla"
